#!/usr/bin/env perl6

use MoarVM::Remote;
use JSON::Fast;


sub MAIN(Int $port) {
    my $remote = await MoarVM::Remote.connect($port);
    say "success!";

    while prompt("> ") -> $_ {
        when / sus[p[e[nd?]?]?]? <.ws> (\d+)? / {
            say "trying to suspend thread $0";
            say await $remote.suspend($0 ?? $0.Int.self !! Whatever);
        }
        when / res[u[m[e?]?]?]? <.ws> (\d+)? / {
            say "trying to resume thread $0";
            say await $remote.resume($0 ?? $0.Int.self !! Whatever);
        }
        when / dump <.ws> (\d+) / {
            say (await $remote.dump($0.Int.self)).&to-json(:pretty);
        }
        when / tl / {
            say (await $remote.threads-list).&to-json(:pretty);
        }
        default {
            say "oh no! don't know what to do with $_"
        }
    }
}
